<div id="widget-container">
        <p style="text-align: center; font-size: 14px;">日付データを読み込み中...</p>
    </div>

    <script>
        // 【提供されたスプレッドシートのCSV公開URL】
        const SPREADSHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQaZcBcRA1Xy1-j5U2rZSopx7Oo1yVxuvXUZA8IBhs3U-mGnEaQhA2eUVBtK53zngWyq_bCBlEHfu3-/pub?gid=1757125327&single=true&output=csv'; 
        
        // ----------------------------------------------------
        // スクリプトの実行ロジック
        // ----------------------------------------------------
        
        // CSVのパースとデータ取得 (省略、前のコードと同一)
        async function fetchAndParseData() {
            // ... (CSVパースロジックは省略) ...
            try {
                const response = await fetch(SPREADSHEET_CSV_URL);
                if (!response.ok) {
                    throw new Error('Failed to fetch spreadsheet data.');
                }
                const csvText = await response.text();
                
                const rows = csvText.trim().split('\n');
                const dataRow = rows.length > 1 ? rows[1].split(',') : [];

                const parsedData = {
                    today: dataRow[1] || '---',       // B列 (Index 1)
                    plus7: dataRow[3] || '---',       // D列 (Index 3)
                    plus14: dataRow[6] || '---',      // G列 (Index 6)
                    shipBefore: dataRow[8] || '---',  // I列 (Index 8)
                    shipAfter: dataRow[10] || '---'   // K列 (Index 10)
                };

                renderWidget(parsedData);

            } catch (error) {
                console.error("Data fetch error:", error);
                document.getElementById('widget-container').innerHTML = 
                    '<p style="color: #e74c3c; text-align: center;">データを読み込めませんでした。スプシの公開設定を確認してください。</p>';
            }
        }

        // リアルタイム時刻更新ロジック (★ここを追加★)
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ja-JP', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            const timeElement = document.getElementById('current-time-display');
            if (timeElement) {
                timeElement.textContent = `現在の時刻: ${timeString}`;
            }
        }
        

        // HTMLレンダリングロジック（時間判定含む）
        function renderWidget(data) {
            const now = new Date();
            const CUTOFF_TIME_MINUTES = 15 * 60 + 30; 
            const currentTimeMinutes = now.getHours() * 60 + now.getMinutes();
            const isAfterCutoff = currentTimeMinutes >= CUTOFF_TIME_MINUTES;
            
            let headers = [];
            let rowData = [];
            
            // 1. 固定の3列を追加
            headers.push("今日は", "定期停止 7日前", "違約金の支払期日");
            rowData.push(data.today, data.plus7, data.plus14);

            // 2. 時刻で最短発送日の列を切り替え（動的な列）
            if (isAfterCutoff) {
                // 15:30以降の場合（翌々営業日を表示）
                headers.push("最短発送");
                rowData.push(data.shipAfter);
            } else {
                // 15:30までの場合（翌営業日を表示）
                headers.push("最短発送");
                rowData.push(data.shipBefore);
            }
            
            // 3. HTMLテーブルを生成
            const container = document.getElementById('widget-container');
            container.innerHTML = `
                <p id="current-time-display" style="
                    text-align: left; 
                    font-weight: bold; 
                    font-size: 1rem; 
                    margin-bottom: 8px; 
                    margin-top: 0;
                    color: #555555; /* 少し薄めの色で目立ちすぎないように */
                ">
                    </p>
                <table class="shipping-table">
                    <thead>
                        <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                    </thead>
                    <tbody>
                        <tr>${rowData.map(d => `<td>${d}</td>`).join('')}</tr>
                    </tbody>
                </table>
            `;
            
            // 初期表示後に時刻を更新
            updateTime();
        }

        // 初期実行
        fetchAndParseData(); // ページロード時にデータ取得と初期レンダリング
        updateTime(); // 初期時刻表示

        // 定期更新: 60秒ごとに時刻とデータ更新を実行
        setInterval(fetchAndParseData, 60000); 
        setInterval(updateTime, 1000); // 時刻は1秒ごとに更新 (リアルタイム感UP)
    </script>
