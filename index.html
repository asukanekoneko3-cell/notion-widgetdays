<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Dynamic Shipping Widget</title>
    
<style>
        /* 1. 全体の設定: Notionに馴染ませる */
        body {
            margin: 0;
            padding: 15px;
            background-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: #37352f; 
            /* ★ Flexboxの配置設定を削除 */
            /* display: flex; を削除 */
            /* flex-direction: column; を削除 */
            /* justify-content: center; を削除 */
            /* align-items: center; を削除 */
            min-height: 100px;
        }
        
        /* 2. テーブル（表）のデザイン - 角丸を適用 */
        .shipping-table {
            /* ★ 幅を制限し、左寄せを確保 */
            max-width: 700px; /* 必要に応じてこの幅を調整してください */
            width: 100%; /* max-widthの範囲で幅を確保 */
            margin: 0; /* body内のマージンをリセット */
            
            border-collapse: separate; 
            border-spacing: 0; 
            border: 1px solid #e0e0e0; 
            border-radius: 12px; 
            overflow: hidden; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); 
        }
        
        /* 3. ヘッダー（タイトル行）のデザイン */
        .shipping-table th {
            padding: 12px 10px;
            font-size: 14px;
            font-weight: 600;
            color: #ffffff; 
            border-right: 1px solid rgba(255, 255, 255, 0.2); 
            border-bottom: 2px solid #e0e0e0;
            letter-spacing: 0.5px; 
            /* ★ セルの内容を中央寄せに戻す */
            text-align: center; 
        }
        /* 各列の背景色をスプシに合わせる */
        .shipping-table th:nth-child(1) { background-color: #555555; }
        .shipping-table th:nth-child(2) { background-color: #e74c3c; }
        .shipping-table th:nth-child(3) { background-color: #9b59b6; }
        .shipping-table th:nth-child(4) { background-color: #2ecc71; }
        
        /* 4. データ行のデザイン */
        .shipping-table td {
            padding: 15px 10px;
            /* ★ セルの内容を中央寄せに戻す */
            text-align: center; 
            background-color: #ffffff; 
            font-size: 1.4rem; 
            font-weight: bold;
            color: #24292e;
            border-right: 1px solid #e0e0e0;
            letter-spacing: 0.8px; 
        }

        /* 最後の列の境界線は不要 */
        .shipping-table th:last-child { border-right: none; }
        .shipping-table td:last-child { border-right: none; }
        
        /* 5. ダークモード対応 */
        @media (prefers-color-scheme: dark) {
            body { color: #ffffff; }
            .shipping-table { border: 1px solid #4d4d4d; box-shadow: none; }
            .shipping-table th { border-right-color: rgba(0, 0, 0, 0.2); border-bottom-color: #4d4d4d; }
            .shipping-table td { 
                background-color: #1f1f1f; 
                color: #ffffff; 
                border-right-color: #4d4d4d;
            }
        }

        /* 6. 時刻表示部分のスタイル */
        #current-time-display {
            width: 100%; /* max-widthが適用されるように */
            max-width: 700px; /* ★ テーブルの幅に合わせる */
            text-align: left; 
            font-weight: bold; 
            font-size: 1rem; 
            margin-bottom: 8px; 
            margin-top: 0;
            color: #555555;
            /* bodyのflexがなくなったため、ここでfloatなどを使わずにwidthを合わせます */
            @media (prefers-color-scheme: dark) {
                color: #aaaaaa;
            }
        }
    </style>
</head>
<body>

    <div id="widget-container">
        <p style="text-align: center; font-size: 14px;">日付データを読み込み中...</p>
    </div>

    <script>
        // 【提供されたスプレッドシートのCSV公開URL】
        const SPREADSHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQaZcBcRA1Xy1-j5U2rZSopx7Oo1yVxuvXUZA8IBhs3U-mGnEaQhA2eUVBtK53zngWyq_bCBlEHfu3-/pub?gid=1757125327&single=true&output=csv'; 
        
        // ----------------------------------------------------
        // スクリプトの実行ロジック
        // ----------------------------------------------------
        
        // CSVのパースとデータ取得
        async function fetchAndParseData() {
            try {
                const response = await fetch(SPREADSHEET_CSV_URL);
                if (!response.ok) {
                    throw new Error('Failed to fetch spreadsheet data.');
                }
                const csvText = await response.text();
                
                const rows = csvText.trim().split('\n');
                const dataRow = rows.length > 1 ? rows[1].split(',') : [];

                const parsedData = {
                    today: dataRow[1] || '---',       // B列 (Index 1)
                    plus7: dataRow[3] || '---',       // D列 (Index 3)
                    plus14: dataRow[6] || '---',      // G列 (Index 6)
                    shipBefore: dataRow[8] || '---',  // I列 (Index 8)
                    shipAfter: dataRow[10] || '---'   // K列 (Index 10)
                };

                renderWidget(parsedData);

            } catch (error) {
                console.error("Data fetch error:", error);
                document.getElementById('widget-container').innerHTML = 
                    '<p style="color: #e74c3c; text-align: center;">データを読み込めませんでした。スプシの公開設定を確認してください。</p>';
            }
        }
        
        // リアルタイム時刻更新ロジック (★ここを追加★)
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ja-JP', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            const timeElement = document.getElementById('current-time-display');
            if (timeElement) {
                timeElement.textContent = `現在の時刻: ${timeString}`;
            }
        }

        // HTMLレンダリングロジック（時間判定含む）
        function renderWidget(data) {
            const now = new Date();
            const CUTOFF_TIME_MINUTES = 15 * 60 + 30; 
            const currentTimeMinutes = now.getHours() * 60 + now.getMinutes();
            const isAfterCutoff = currentTimeMinutes >= CUTOFF_TIME_MINUTES;
            
            let headers = [];
            let rowData = [];
            
            // 1. 固定の3列を追加
            headers.push("今日は", "定期停止 7日前", "違約金の支払期日");
            rowData.push(data.today, data.plus7, data.plus14);

            // 2. 時刻で最短発送日の列を切り替え（動的な列）
            if (isAfterCutoff) {
                // 15:30以降の場合（翌々営業日を表示）
                headers.push("最短発送");
                rowData.push(data.shipAfter);
            } else {
                // 15:30までの場合（翌営業日を表示）
                headers.push("最短発送");
                rowData.push(data.shipBefore);
            }
            
            // 3. HTMLテーブルを生成
            const container = document.getElementById('widget-container');
            container.innerHTML = `
                <p id="current-time-display">
                    </p>
                <table class="shipping-table">
                    <thead>
                        <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                    </thead>
                    <tbody>
                        <tr>${rowData.map(d => `<td>${d}</td>`).join('')}</tr>
                    </tbody>
                </table>
            `;
            
            // 初期表示後に時刻を更新
            updateTime();
        }

        // 初期実行
        fetchAndParseData(); // ページロード時にデータ取得と初期レンダリング
        updateTime(); // 初期時刻表示

        // 定期更新: 60秒ごとにデータ取得と再レンダリング
        setInterval(fetchAndParseData, 60000); 
        // 時刻は1秒ごとに更新 (リアルタイム感UP)
        setInterval(updateTime, 1000); 
    </script>
</body>
</html>

